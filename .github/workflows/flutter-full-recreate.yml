name: Flutter Full Recreate (v2 Safe)

on:
  workflow_dispatch:

jobs:
  recreate-flutter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Backup app source
        run: |
          mkdir /tmp/flutter_backup
          cp -r lib /tmp/flutter_backup/lib || true
          cp -r assets /tmp/flutter_backup/assets || true
          cp pubspec.yaml /tmp/flutter_backup/pubspec.yaml

      - name: Remove old Flutter structure
        run: |
          rm -rf android ios web windows linux macos .dart_tool build

      - name: Recreate Flutter project (v2 embedding)
        run: |
          flutter create .

      - name: Restore app source
        run: |
          rm -rf lib assets pubspec.yaml
          cp -r /tmp/flutter_backup/lib ./lib || true
          cp -r /tmp/flutter_backup/assets ./assets || true
          cp /tmp/flutter_backup/pubspec.yaml ./pubspec.yaml

      - name: Flutter pub get
        run: flutter pub get

      - name: Commit & push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "chore: full flutter recreate with v2 embedding" || echo "No changes"
          git pull --rebase origin main
          git push
