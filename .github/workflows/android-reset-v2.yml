name: Android Reset to Embedding v2 (FINAL FIX)

on:
  workflow_dispatch:

jobs:
  android-reset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      # ğŸ›  FIX pubspec.yaml name
      - name: Fix pubspec.yaml package name
        run: |
          sed -i 's/^name:.*/name: raonson_v1/' pubspec.yaml
          echo "pubspec.yaml fixed:"
          head -n 5 pubspec.yaml

      # ğŸ”¥ REMOVE OLD ANDROID (v1 embedding)
      - name: Remove android folder
        run: rm -rf android

      # âœ… FORCE PROJECT NAME (THIS FIXES THE ERROR)
      - name: Recreate Android with embedding v2
        run: flutter create --platforms=android --project-name raonson_v1 .

      # ğŸ” VERIFY v2 EMBEDDING
      - name: Verify Android embedding v2
        run: |
          if grep -R "io.flutter.app" android/; then
            echo "âŒ Found v1 embedding"
            exit 1
          fi
          if grep -R "FlutterApplication" android/; then
            echo "âŒ Found old FlutterApplication"
            exit 1
          fi
          echo "âœ… Android v2 embedding confirmed"

      # ğŸ§ª QUICK DEBUG BUILD
      - name: Android debug build
        run: flutter build apk --debug
