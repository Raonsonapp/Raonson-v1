name: Android Reset to Embedding v2 (Safe)

on:
  workflow_dispatch:

jobs:
  android-reset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      # ğŸ›  FIX pubspec name (Raonson-v1 â†’ raonson_v1)
      - name: Fix pubspec.yaml package name
        run: |
          sed -i 's/^name:.*/name: raonson_v1/' pubspec.yaml
          cat pubspec.yaml | head -n 5

      # ğŸ”¥ REMOVE OLD ANDROID (v1 may exist)
      - name: Remove android folder
        run: rm -rf android

      # ğŸ” RECREATE ANDROID WITH V2 EMBEDDING
      - name: Recreate Android (v2)
        run: flutter create --platforms=android .

      # ğŸ” VERIFY NO V1 EMBEDDING LEFT
      - name: Verify Android embedding v2
        run: |
          if grep -R "io.flutter.app" android/; then
            echo "âŒ Found v1 embedding"
            exit 1
          fi
          if grep -R "FlutterApplication" android/; then
            echo "âŒ Found old FlutterApplication"
            exit 1
          fi
          echo "âœ… Android v2 embedding OK"

      # ğŸ§ª FAST CHECK (debug only)
      - name: Android debug build check
        run: flutter build apk --debug
