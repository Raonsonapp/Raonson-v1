name: Android Embedding Check & Fix (v1 â†’ v2)

on:
  push:
    paths:
      - "android/**"
      - "pubspec.yaml"
  workflow_dispatch:

jobs:
  android-fix:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      # 3ï¸âƒ£ Flutter doctor (info only)
      - name: Flutter doctor
        run: flutter doctor -v

      # 4ï¸âƒ£ Detect Android v1 embedding
      - name: Detect Android v1 embedding
        id: detect
        run: |
          echo "ğŸ” Checking for Android v1 embedding..."
          if grep -R "io.flutter.app" android/ || grep -R "FlutterApplication" android/; then
            echo "V1_FOUND=true" >> $GITHUB_ENV
            echo "âŒ Android v1 embedding detected"
          else
            echo "V1_FOUND=false" >> $GITHUB_ENV
            echo "âœ… Android v2 embedding already in use"
          fi

      # 5ï¸âƒ£ Auto-fix: regenerate Android (SAFE)
      - name: Fix Android embedding to v2
        if: env.V1_FOUND == 'true'
        run: |
          echo "ğŸ›  Fixing Android embedding (v1 â†’ v2)"
          flutter create .

      # 6ï¸âƒ£ Verify MainActivity
      - name: Verify MainActivity (v2)
        run: |
          echo "ğŸ” Verifying MainActivity..."
          cat android/app/src/main/kotlin/**/MainActivity.kt || true

      # 7ï¸âƒ£ Verify AndroidManifest
      - name: Verify AndroidManifest
        run: |
          echo "ğŸ” Checking AndroidManifest..."
          grep -R "FlutterApplication" android/ || echo "âœ… OK (no v1 leftovers)"

      # 8ï¸âƒ£ Pubspec SDK constraint check
      - name: Check Dart SDK constraint
        run: |
          echo "ğŸ” Checking SDK constraint..."
          if ! grep -q "sdk:" pubspec.yaml; then
            echo "âŒ Missing Dart SDK constraint in pubspec.yaml"
            exit 1
          else
            echo "âœ… SDK constraint found"
          fi

      # 9ï¸âƒ£ Report only (no build)
      - name: Final report
        run: |
          echo "=============================="
          echo "ANDROID CHECK FINISHED"
          echo "V1 embedding fixed: $V1_FOUND"
          echo "No build was executed"
          echo "=============================="
